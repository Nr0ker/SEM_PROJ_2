{% extends "header.html" %}
{% block title %}View Product - {{ product.name }}{% endblock %}
{% block style %}<link rel="stylesheet" href="/static/view_product.css">{% endblock %}
{% block content %}
<div class="container">
    <h1>Product Details</h1>

    <div class="product-detail">
        <h2>{{ product.name }}</h2>

        {% if product.photo %}
            <img src="data:image/jpeg;base64,{{ product.photo }}" alt="{{ product.name }}" class="product-image">
        {% else %}
            <p>No image available</p>
        {% endif %}

        <p><strong>Description:</strong> {{ product.desc }}</p>
        <p><strong>Current Price:</strong> <span id="current-price">${{ product.curr_price }}</span></p>

        <a href="/" class="back-button">Back to Products List</a>
        <a href="/add_to_cart/{{ user.id }}/{{ product.id }}">
            <button>Add to Cart</button>
        </a>
    </div>
</div>

<div>
    <h3>Price Update History</h3>
    <ul id="price-history">
        {% for update in price_updates %}
            <li><strong>{{ update.timestamp.strftime('%m/%d/%Y %H:%M:%S') }}:</strong> ${{ update.new_price }}</li>
        {% endfor %}
    </ul>
</div>

<div>
    <p>Send a Price Update:</p>
    <input
        type="number"
        id="price-input"
        placeholder="Enter new price"
        step="0.01"
        min="{{ product.curr_price }}"
    />
    <button id="send-update">Send Update</button>
</div>

<script>
    const socket = new WebSocket(`ws://localhost:8000/ws/{{ product.id }}`);

    let inactivityTimeout = null; // To track inactivity for adding the product to the cart.

    // Function to reset the inactivity timer
    function resetInactivityTimer() {
        if (inactivityTimeout) clearTimeout(inactivityTimeout);
        inactivityTimeout = setTimeout(() => {
            // Send product to the user's cart and notify
            window.location.href = `/add_to_cart/{{ user.id }}/{{ product.id }}`;
            alert("This product has been added to your cart due to inactivity.");
        }, 300000); // 5 minutes (300,000 ms)
    }

    // Reset timer on page load
    resetInactivityTimer();

    // Listen for incoming messages
    socket.onmessage = function(event) {
        resetInactivityTimer(); // Reset inactivity timer on updates
        const data = JSON.parse(event.data);
        if (data.productId === {{ product.id }}) {
            // Update the current price display
            document.getElementById("current-price").innerText = `$${data.newPrice.toFixed(2)}`;

            // Append to the price history
            const history = document.getElementById("price-history");
            const newItem = document.createElement("li");
            newItem.innerHTML = `<strong>${new Date(data.timestamp).toLocaleString('en-US')}:</strong> $${data.newPrice.toFixed(2)}`;
            history.appendChild(newItem);
        }
    };

    // Send updates when the button is clicked
    document.getElementById("send-update").addEventListener("click", function() {
        const newPrice = parseFloat(document.getElementById("price-input").value);
        const userId = {{ user.id }};
        const currPrice = parseFloat(document.getElementById("current-price").innerText.replace('$', ''));

        // Prevent price updates lower than the current price
        if (!isNaN(newPrice) && newPrice > currPrice) {
            socket.send(JSON.stringify({
                productId: {{ product.id }},
                userId: userId,
                newPrice: newPrice,
                timestamp: new Date().toISOString() // Send the current timestamp
            }));
        } else {
            alert("The new price must be higher than the current price.");
        }
    });
</script>
{% endblock %}
